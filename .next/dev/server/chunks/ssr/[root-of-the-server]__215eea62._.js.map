{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/harsh/Downloads/PulseBank-main/PulseBank-main/app/hospital/new-request/page.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { Heart, ArrowLeft } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\n\r\nexport default function NewRequest() {\r\n  const router = useRouter();\r\n  const [loading, setLoading] = useState(false);\r\n  const [formData, setFormData] = useState({\r\n    bloodType: \"O+\",\r\n    unitsNeeded: 1,\r\n    urgency: \"MODERATE\",\r\n    patientName: \"\",\r\n    patientAge: 0,\r\n    reason: \"\",\r\n  });\r\n\r\n  const handleChange = (e: any) => {\r\n    const { name, value } = e.target;\r\n    setFormData((prev) => ({\r\n      ...prev,\r\n      [name]: name === \"unitsNeeded\" || name === \"patientAge\" ? (value === \"\" ? 0 : parseInt(value)) : value,\r\n    }));\r\n  };\r\n\r\n  const captureLocation = () => {\r\n    if (!navigator.geolocation) return alert(\"Your browser does not support geolocation\");\r\n    navigator.geolocation.getCurrentPosition(\r\n      (pos) => {\r\n        alert(\"üìç Location captured for this request\");\r\n      },\r\n      (err) => {\r\n        if (err.code === 1) alert(\"Please allow location access to capture hospital coordinates\");\r\n        else alert(\"Unable to get location: \" + err.message);\r\n      },\r\n      { enableHighAccuracy: true }\r\n    );\r\n  };\r\n\r\n  const handleSubmit = async (e: any) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n\r\n    try {\r\n      const token = localStorage.getItem(\"token\");\r\n      const userStr = localStorage.getItem(\"user\");\r\n      \r\n      if (!token) {\r\n        alert(\"‚ùå You are not logged in. Please log in again.\");\r\n        setLoading(false);\r\n        return;\r\n      }\r\n\r\n      // Try to get userId from JWT token\r\n      let userId: string | null = null;\r\n      if (token) {\r\n        try {\r\n          const decoded: any = JSON.parse(atob(token.split('.')[1]));\r\n          userId = decoded.userId;\r\n        } catch (e) {\r\n          console.log(\"Could not decode token, using localStorage\");\r\n        }\r\n      }\r\n\r\n      // Fallback to localStorage if token decode failed\r\n      if (!userId && userStr) {\r\n        const user = JSON.parse(userStr);\r\n        userId = user?._id || user?.id || user?.userId;\r\n      }\r\n\r\n      if (!userId) {\r\n        alert(\"‚ùå Hospital ID not found. Please log in again.\");\r\n        setLoading(false);\r\n        return;\r\n      }\r\n\r\n      const user = userStr ? JSON.parse(userStr) : null;\r\n\r\n      // Fetch fresh hospital data from backend to ensure we have latest location\r\n      const hospitalRes = await fetch(`http://localhost:5000/auth/user/${userId}`);\r\n      const hospitalData = await hospitalRes.json();\r\n      const hospital = hospitalData.user || user;\r\n\r\n      console.log(\"[Hospital Request] Fresh hospital data from backend:\", hospital);\r\n      console.log(\"[Hospital Request] Hospital location from backend:\", hospital?.location);\r\n      \r\n      if (hospital?.location) {\r\n        console.log(\"[Hospital Request] ‚úÖ Location found - Lat:\", hospital.location.latitude, \"Lng:\", hospital.location.longitude);\r\n      } else {\r\n        console.warn(\"[Hospital Request] ‚ö†Ô∏è NO LOCATION FOUND - using fallback from localStorage\");\r\n      }\r\n\r\n      const hospitalName = hospital?.fullName || hospital?.name || user?.fullName || user?.name;\r\n\r\n      if (!hospitalName) {\r\n        alert(\"‚ùå Hospital name not found. Please log in again.\");\r\n        setLoading(false);\r\n        return;\r\n      }\r\n\r\n      // **CRITICAL**: Check if hospital has location\r\n      if (!hospital?.location || !hospital.location.latitude || !hospital.location.longitude) {\r\n        alert(\"‚ùå Hospital location not found!\\n\\nPlease update your hospital location in your profile before creating requests.\\n\\nThis will help donors find your blood requests on the map.\");\r\n        setLoading(false);\r\n        router.push(\"/hospital/profile\");\r\n        return;\r\n      }\r\n\r\n      const requestPayload = {\r\n        bloodType: formData.bloodType,\r\n        unitsNeeded: formData.unitsNeeded,\r\n        hospital: hospitalName,\r\n        urgency: formData.urgency,\r\n        recipientName: formData.patientName || null,\r\n        locationKm: 10,\r\n        location: hospital?.location ? { latitude: hospital.location.latitude, longitude: hospital.location.longitude } : undefined,\r\n        requestedBy: userId,\r\n      };\r\n\r\n      console.log(\"[Hospital Request] Payload being sent:\", requestPayload);\r\n\r\n      const res = await fetch(\"http://localhost:5000/request/add\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(requestPayload),\r\n      });\r\n\r\n      const data = await res.json();\r\n\r\n      if (data.success) {\r\n        alert(\"‚úÖ Blood request created successfully!\");\r\n        router.push(\"/hospital/dashboard\");\r\n      } else {\r\n        alert(\"‚ùå Error: \" + (data.message || \"Could not create request\"));\r\n      }\r\n    } catch (err) {\r\n      console.error(err);\r\n      alert(\"‚ùå Network error: \" + (err instanceof Error ? err.message : \"Unknown error\"));\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <main className=\"min-h-screen bg-linear-to-br from-white via-red-50 to-white\">\r\n      {/* HEADER */}\r\n      <header className=\"bg-linear-to-r from-red-600 to-red-700 text-white p-6 shadow-lg\">\r\n        <div className=\"max-w-7xl mx-auto flex items-center gap-4\">\r\n          <Link href=\"/hospital/dashboard\" className=\"hover:bg-red-500 p-2 rounded-lg transition\">\r\n            <ArrowLeft className=\"w-6 h-6\" />\r\n          </Link>\r\n          <div className=\"flex items-center gap-3\">\r\n            <Heart className=\"w-8 h-8 fill-white\" />\r\n            <h1 className=\"text-3xl font-bold\">Create Blood Request</h1>\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      {/* FORM */}\r\n      <div className=\"max-w-2xl mx-auto p-6\">\r\n        <div className=\"bg-white rounded-xl shadow-lg p-8\">\r\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n            {/* BLOOD TYPE */}\r\n            <div>\r\n              <label className=\"block text-sm font-semibold text-gray-700 mb-2\">Blood Type *</label>\r\n              <select\r\n                name=\"bloodType\"\r\n                value={formData.bloodType}\r\n                onChange={handleChange}\r\n                title=\"Blood Type Selection\"\r\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600\"\r\n              >\r\n                {[\"O+\", \"O-\", \"A+\", \"A-\", \"B+\", \"B-\", \"AB+\", \"AB-\"].map((type) => (\r\n                  <option key={type} value={type}>\r\n                    {type}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n\r\n            {/* UNITS NEEDED */}\r\n            <div>\r\n              <label className=\"block text-sm font-semibold text-gray-700 mb-2\">Units Needed *</label>\r\n              <input\r\n                type=\"number\"\r\n                name=\"unitsNeeded\"\r\n                min=\"1\"\r\n                max=\"10\"\r\n                value={formData.unitsNeeded}\r\n                onChange={handleChange}\r\n                placeholder=\"Enter units needed\"\r\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600\"\r\n              />\r\n            </div>\r\n\r\n            {/* URGENCY */}\r\n            <div>\r\n              <label className=\"block text-sm font-semibold text-gray-700 mb-2\">Urgency Level *</label>\r\n              <select\r\n                name=\"urgency\"\r\n                value={formData.urgency}\r\n                onChange={handleChange}\r\n                title=\"Urgency Level Selection\"\r\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600\"\r\n              >\r\n                <option value=\"LOW\">Low</option>\r\n                <option value=\"MODERATE\">Moderate</option>\r\n                <option value=\"HIGH\">High</option>\r\n                <option value=\"CRITICAL\">Critical</option>\r\n              </select>\r\n            </div>\r\n\r\n            {/* PATIENT NAME */}\r\n            <div>\r\n              <label className=\"block text-sm font-semibold text-gray-700 mb-2\">Patient Name</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"patientName\"\r\n                value={formData.patientName}\r\n                onChange={handleChange}\r\n                placeholder=\"Enter patient name\"\r\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600\"\r\n              />\r\n            </div>\r\n\r\n            {/* PATIENT AGE */}\r\n            <div>\r\n              <label className=\"block text-sm font-semibold text-gray-700 mb-2\">Patient Age</label>\r\n              <input\r\n                type=\"number\"\r\n                name=\"patientAge\"\r\n                min=\"0\"\r\n                max=\"120\"\r\n                value={formData.patientAge}\r\n                onChange={handleChange}\r\n                placeholder=\"Enter patient age\"\r\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600\"\r\n              />\r\n            </div>\r\n\r\n            {/* REASON */}\r\n            <div>\r\n              <label className=\"block text-sm font-semibold text-gray-700 mb-2\">Reason for Request</label>\r\n              <textarea\r\n                name=\"reason\"\r\n                value={formData.reason}\r\n                onChange={handleChange}\r\n                placeholder=\"e.g., Emergency surgery, accident, chronic condition...\"\r\n                rows={4}\r\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600\"\r\n              />\r\n            </div>\r\n\r\n            {/* SUBMIT BUTTONS */}\r\n            <div className=\"flex gap-4 pt-4\">\r\n              <button\r\n                type=\"submit\"\r\n                disabled={loading}\r\n                className=\"flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              >\r\n                {loading ? \"Creating...\" : \"Create Request\"}\r\n              </button>\r\n              <Link\r\n                href=\"/hospital/dashboard\"\r\n                className=\"flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 rounded-lg text-center transition\"\r\n              >\r\n                Cancel\r\n              </Link>\r\n            </div>\r\n          </form>\r\n        </div>\r\n      </div>\r\n    </main>\r\n  );\r\n}\r\n\r\n"],"names":[],"mappings":"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","debugId":null}}]
}