{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/harsh/Downloads/PulseBank-main/PulseBank-main/app/hospital/history/page.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { jwtDecode } from \"jwt-decode\";\r\nimport { Heart, ArrowLeft, MapPin, Calendar, Droplet } from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport dynamic from \"next/dynamic\";\r\n\r\nconst LeafletMap = dynamic(() => import(\"@/components/LeafletMap\"), {\r\n  ssr: false,\r\n});\r\n\r\nexport default function HospitalHistory() {\r\n  const [hospitalId, setHospitalId] = useState<string | null>(null);\r\n  const [hospitalName, setHospitalName] = useState(\"Hospital\");\r\n  const [requests, setRequests] = useState<any[]>([]);\r\n  const [schedules, setSchedules] = useState<any[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  useEffect(() => {\r\n    const stored = localStorage.getItem(\"user\");\r\n    if (stored) {\r\n      const user = JSON.parse(stored);\r\n      setHospitalId(user._id || user.id || null);\r\n      setHospitalName(user.fullName || \"Hospital\");\r\n    }\r\n    // fallback: try to decode token\r\n    if (!stored) {\r\n      const token = localStorage.getItem(\"token\");\r\n      if (token) {\r\n        try {\r\n          const d: any = jwtDecode(token);\r\n          setHospitalId(d.userId || d._id || null);\r\n        } catch (e) {\r\n          // ignore\r\n        }\r\n      }\r\n    }\r\n  }, []);\r\n\r\n  // Fetch history data\r\n  useEffect(() => {\r\n    if (!hospitalName) return;\r\n\r\n    setLoading(true);\r\n\r\n    Promise.all([\r\n      fetch(\"http://localhost:5000/request/all\").then((res) => res.json()),\r\n      fetch(`http://localhost:5000/hospital/schedules/${encodeURIComponent(hospitalName)}`).then((res) => res.json()),\r\n    ])\r\n      .then(([requestRes, scheduleRes]) => {\r\n        // All requests created by this hospital\r\n        const allRequests = requestRes.requests || [];\r\n        const myRequests = allRequests.filter((r: any) => r.hospital === hospitalName);\r\n        setRequests(myRequests);\r\n\r\n        // All schedules for this hospital - filter only completed ones with date/time in past\r\n        const allSchedules = scheduleRes.schedules || [];\r\n        const now = new Date();\r\n        \r\n        // Deduplicate and filter by date reached + completed status\r\n        const seen = new Set<string>();\r\n        const completedSchedules = allSchedules\r\n          .filter((s: any) => {\r\n            if (!s.status || s.status.toLowerCase() !== \"completed\") return false;\r\n            \r\n            // Check if date & time has passed\r\n            try {\r\n              const scheduleDateTime = new Date(`${s.date} ${s.time}`);\r\n              if (scheduleDateTime > now) return false; // Future date, skip\r\n            } catch (e) {\r\n              return false; // Invalid date format\r\n            }\r\n            \r\n            // Deduplicate by donor + date + time combination\r\n            const key = `${s.donorName}-${s.date}-${s.time}`;\r\n            if (seen.has(key)) return false;\r\n            seen.add(key);\r\n            return true;\r\n          })\r\n          .sort((a: any, b: any) => {\r\n            // Sort by date and time in descending order (most recent first)\r\n            const dateA = new Date(`${a.date} ${a.time}`);\r\n            const dateB = new Date(`${b.date} ${b.time}`);\r\n            return dateB.getTime() - dateA.getTime();\r\n          });\r\n        \r\n        setSchedules(completedSchedules);\r\n\r\n        setLoading(false);\r\n      })\r\n      .catch((err) => {\r\n        console.error(\"Error fetching history:\", err);\r\n        setLoading(false);\r\n      });\r\n  }, [hospitalName]);\r\n\r\n  return (\r\n    <main className=\"min-h-screen bg-gradient-to-br from-white via-red-50 to-white\">\r\n      <header className=\"bg-gradient-to-r from-red-600 to-red-700 text-white p-6 sticky top-0 z-30 shadow-lg\">\r\n        <div className=\"max-w-6xl mx-auto flex items-center gap-4\">\r\n          <Link href=\"/hospital/dashboard\" className=\"hover:opacity-80 transition\">\r\n            <ArrowLeft className=\"w-6 h-6\" />\r\n          </Link>\r\n          <Heart className=\"w-8 h-8 fill-white\" />\r\n          <h1 className=\"text-2xl font-bold\">Hospital History</h1>\r\n        </div>\r\n      </header>\r\n\r\n      <div className=\"max-w-6xl mx-auto p-6\">\r\n        {loading ? (\r\n          <div className=\"flex items-center justify-center h-96\">\r\n            <p className=\"text-gray-600 text-lg\">Loading history...</p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-8\">\r\n            {/* Requests Created by Hospital */}\r\n            {requests.length > 0 ? (\r\n              <div className=\"bg-white rounded-2xl shadow-xl p-8 border-2 border-red-200\">\r\n                <div className=\"flex items-center gap-3 mb-6\">\r\n                  <Droplet className=\"w-8 h-8 text-red-600\" />\r\n                  <h2 className=\"text-3xl font-bold text-red-700\">Blood Requests Created</h2>\r\n                </div>\r\n\r\n                <div className=\"space-y-4\">\r\n                  {requests.map((r, i) => (\r\n                    <div key={i} className=\"p-6 border-2 border-red-100 rounded-xl hover:shadow-lg transition\">\r\n                      <div className=\"flex items-start justify-between mb-4\">\r\n                        <div>\r\n                          <p className=\"text-2xl font-bold text-red-700\">{r.bloodType}</p>\r\n                          <p className=\"text-gray-600 mt-1\">{r.unitsNeeded} units needed</p>\r\n                        </div>\r\n                        <span className={`px-4 py-2 rounded-full font-semibold text-sm ${\r\n                          r.urgency === \"critical\" ? \"bg-red-100 text-red-700\" :\r\n                          r.urgency === \"high\" ? \"bg-orange-100 text-orange-700\" :\r\n                          \"bg-yellow-100 text-yellow-700\"\r\n                        }`}>\r\n                          {r.urgency?.toUpperCase() || \"NORMAL\"}\r\n                        </span>\r\n                      </div>\r\n\r\n                      <div className=\"grid md:grid-cols-2 gap-4 mb-4 text-gray-700\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Calendar className=\"w-5 h-5 text-red-600\" />\r\n                          <span>{new Date(r.createdAt).toLocaleDateString()}</span>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Heart className=\"w-5 h-5 text-red-600\" />\r\n                          <span>Status: {r.status || \"Pending\"}</span>\r\n                        </div>\r\n                      </div>\r\n\r\n                      {/* Map for location */}\r\n                      {r.location && r.location.latitude && r.location.longitude ? (\r\n                        <div className=\"mt-4 h-48 overflow-hidden rounded-lg border-2 border-red-100\">\r\n                          <LeafletMap activeDonors={[{ location: r.location, fullName: r.hospital }]} />\r\n                        </div>\r\n                      ) : null}\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            ) : (\r\n              <div className=\"bg-white rounded-2xl shadow-xl p-8 border-2 border-red-200 text-center\">\r\n                <Droplet className=\"w-16 h-16 text-gray-400 mx-auto mb-4\" />\r\n                <p className=\"text-gray-600 text-lg\">No blood requests created yet</p>\r\n              </div>\r\n            )}\r\n\r\n            {/* Donation Schedules Accepted */}\r\n            {schedules.length > 0 ? (\r\n              <div className=\"bg-white rounded-2xl shadow-xl p-8 border-2 border-green-200\">\r\n                <div className=\"flex items-center gap-3 mb-6\">\r\n                  <Calendar className=\"w-8 h-8 text-green-600\" />\r\n                  <h2 className=\"text-3xl font-bold text-green-700\">Completed Donations</h2>\r\n                </div>\r\n\r\n                <div className=\"space-y-4\">\r\n                  {schedules.map((s, idx) => (\r\n                    <div key={idx} className=\"p-6 border-2 border-green-100 rounded-xl hover:shadow-lg transition\">\r\n                      <div className=\"flex items-start justify-between mb-4\">\r\n                        <div>\r\n                          <p className=\"text-xl font-bold text-green-700\">Donor: {s.donorName}</p>\r\n                          <p className=\"text-gray-600 mt-1\">Blood Type: {s.bloodType}</p>\r\n                        </div>\r\n                        <span className=\"px-4 py-2 rounded-full font-semibold text-sm bg-green-100 text-green-700\">\r\n                          COMPLETED\r\n                        </span>\r\n                      </div>\r\n\r\n                      <div className=\"grid md:grid-cols-3 gap-4 text-gray-700\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Calendar className=\"w-5 h-5 text-green-600\" />\r\n                          <span>{s.date} at {s.time}</span>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Droplet className=\"w-5 h-5 text-green-600\" />\r\n                          <span>{s.unitsNeeded} units collected</span>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Heart className=\"w-5 h-5 text-green-600\" />\r\n                          <span>Successfully donated</span>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            ) : (\r\n              <div className=\"bg-white rounded-2xl shadow-xl p-8 border-2 border-green-200 text-center\">\r\n                <Calendar className=\"w-16 h-16 text-gray-400 mx-auto mb-4\" />\r\n                <p className=\"text-gray-600 text-lg\">No completed donations yet</p>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </main>\r\n  );\r\n}\r\n\r\n"],"names":[],"mappings":"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","debugId":null}}]
}